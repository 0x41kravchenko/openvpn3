From 483609eacd9fb05b18e872099f88c689271aafe4 Mon Sep 17 00:00:00 2001
From: James Yonan <james@openvpn.net>
Date: Mon, 27 Feb 2017 13:01:26 -0700
Subject: [PATCH] Added user code hook async_connect_post_open() to be called
 immediately after socket open in async_connect.

---
 asio/include/asio/basic_socket.hpp | 22 +++++++++++++++++++++-
 1 file changed, 21 insertions(+), 1 deletion(-)

diff --git a/asio/include/asio/basic_socket.hpp b/asio/include/asio/basic_socket.hpp
index 42efbda4..db349067 100644
--- a/asio/include/asio/basic_socket.hpp
+++ b/asio/include/asio/basic_socket.hpp
@@ -949,7 +949,22 @@ public:
     if (!is_open())
     {
       const protocol_type protocol = peer_endpoint.protocol();
-      impl_.get_service().open(impl_.get_implementation(), protocol, open_ec);
+      this->get_service().open(this->get_implementation(), protocol, open_ec);
+      if (!open_ec)
+	async_connect_post_open(protocol, open_ec);
+      if (open_ec)
+      {
+        async_completion<ConnectHandler,
+          void (asio::error_code)> init(handler);
+
+        asio::post(this->get_executor(),
+            asio::detail::bind_handler(
+              ASIO_MOVE_CAST(ASIO_HANDLER_TYPE(
+                ConnectHandler, void (asio::error_code)))(
+                  init.completion_handler), open_ec));
+
+        return init.result.get();
+      }
     }
 
     return async_initiate<ConnectHandler, void (asio::error_code)>(
@@ -1800,6 +1815,11 @@ protected:
 #endif
 
 private:
+  // optional user code hook immediately after socket open in async_connect
+  virtual void async_connect_post_open(const protocol_type& protocol, asio::error_code& ec)
+  {
+  }
+
   // Disallow copying and assignment.
   basic_socket(const basic_socket&) ASIO_DELETED;
   basic_socket& operator=(const basic_socket&) ASIO_DELETED;
-- 
2.21.0

