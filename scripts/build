#!/usr/bin/env bash
if [ -z "$1" ]; then
    echo "usage: ./build target"
    echo "options:"
    echo " DEBUG=1 -- enable debug"
    echo ' ECHO=1 -- show commands'
    echo " STRIP=1 -- strip binary"
    echo " STRICT=1 -- more warnings"
    echo " LTO=1 -- build with LTO"
    echo " GPROF=1 -- build for gprof profiling"
    echo " PGEN=1 -- generate data for profile-guided optimization"
    echo " PUSE=1 -- use data from previous run of PGEN=1 build"
    echo " OSSL=1 -- include OpenSSL on Mac"
    echo " SSL_BOTH=1 -- include OpenSSL and Apple SSL on Mac"
    echo " NOTHREADS=1 -- disable threads"
    echo ' GCC_EXTRA="-DITER=5" -- add build flags'
    exit 1
fi

# remove previous build
rm -f $1

# build flags
FLAGS="-Wall"
[ "$STRICT" = "1" ] && FLAGS="$FLAGS -Wextra"
FLAGS="$FLAGS -Wno-sign-compare -Wno-unused-parameter"

# special Mac settings
if [ "$PLATFORM" = "mac" ]; then
    # On Mac, only link with OpenSSL if OSSL is defined.
    # On other platforms, always link with OpenSSL.
    if [ "$SSL_BOTH" = "1" ]; then
	CRYPTO_LIBS="-DUSE_APPLE_SSL -DUSE_OPENSSL -lcrypto -lssl -framework Security"
    else
	if [ "$OSSL" = "1" ]; then
	    CRYPTO_LIBS="-DUSE_OPENSSL -lcrypto -lssl"
	else
	    CRYPTO_LIBS="-DUSE_APPLE_SSL -framework Security"
	fi
    fi

    # Include other Mac frameworks
    # -framework CoreServices
    CRYPTO_LIBS="$CRYPTO_LIBS -framework CoreFoundation"
else
    CRYPTO_LIBS="-DUSE_OPENSSL -lcrypto -lssl"
fi

# boost link libraries
BOOST_LIBS="-lboost_system"
if [ "$NOTHREADS" = "1" ]; then
    FLAGS="$FLAGS -DBOOST_DISABLE_THREADS"
else
    BOOST_LIBS="$BOOST_LIBS -lboost_thread"
    FLAGS="$FLAGS -pthread"
fi

# profile-guided optimization
if [ "$PGEN" = "1" ]; then
    FLAGS="$FLAGS -fprofile-generate"
elif [ "$PUSE" = "1" ]; then
    FLAGS="$FLAGS -fprofile-use"
fi

if [ "$DEBUG" = "1" ]; then
    # debug build
    CMD="g++ -g $FLAGS $GCC_EXTRA -I$BOOST -I$OVPN3 -L$BOOST/stage/lib $1.cpp -o $1 $BOOST_LIBS $CRYPTO_LIBS"
else
    # release build
    [ "$LTO" = "1" ] && FLAGS="$FLAGS -flto=4 -Wl,--no-as-needed"
    [ "$GPROF" = "1" ] && FLAGS="$FLAGS -pg"
    CMD="g++ -O3 -fwhole-program $FLAGS $GCC_EXTRA -I$BOOST -I$OVPN3 -L$BOOST/stage/lib $1.cpp -o $1 $BOOST_LIBS $CRYPTO_LIBS"
fi

# execute CMD
[ "$ECHO" = "1" ] && echo $CMD
$CMD

# maybe strip
[ "$STRIP" = "1" ] && strip $1
exit 0
